name: Build Kivy Android APK In Release Mode

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost"
        sudo apt-get clean

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential git zip unzip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake gettext libltdl-dev libffi-dev libssl-dev

    - name: Install Buildozer and Cython
      run: |
        # 必须先卸载再安装，确保版本唯一
        pip3 uninstall -y Cython
        pip3 install --user "buildozer>=1.5.0" "Cython==0.29.33"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Build with Buildozer
      run: |
        # 强制删除所有旧缓存，防止 127 错误残留
        rm -rf .buildozer
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        # 使用详细模式，并跳过签名步骤（Debug 模式先跑通）
        buildozer -v android debug
      env:
        BUILDOZER_ALLOW_ORG_NAME_START_WITH_NUMBER: 1