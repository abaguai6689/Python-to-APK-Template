name: Build Kivy Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" /usr/local/lib/android/sdk/ndk/
        sudo apt-get clean
        df -h

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            autoconf \
            automake \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libtinfo5 \
            cmake \
            gettext \
            libltdl-dev \
            libffi-dev \
            libssl-dev

    - name: Install Buildozer and Cython
      run: |
        pip3 install --user --upgrade "buildozer>=1.5.0" "Cython==0.29.33"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Cache Buildozer dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Inject crash handler into main.py
      run: |
        cat > crash_handler.py << 'ENDOFFILE'
        # 自动注入的崩溃日志捕获器
        import os
        import sys
        import traceback
        from datetime import datetime
        
        CRASH_LOG_DIR = '/sdcard/DaveSaveEd/crashes' if os.path.exists('/sdcard') else os.path.expanduser('~')
        
        def handle_exception(exc_type, exc_value, exc_traceback):
            if issubclass(exc_type, KeyboardInterrupt):
                sys.__excepthook__(exc_type, exc_value, exc_traceback)
                return
            
            error_msg = ''.join(traceback.format_exception(exc_type, exc_value, exc_traceback))
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            
            try:
                os.makedirs(CRASH_LOG_DIR, exist_ok=True)
                log_file = os.path.join(CRASH_LOG_DIR, f'crash_{timestamp}.log')
                with open(log_file, 'w', encoding='utf-8') as f:
                    f.write(f"DaveSaveEd Crash Log\n")
                    f.write(f"Time: {timestamp}\n")
                    f.write(f"{'='*50}\n")
                    f.write(error_msg)
                print(f"Crash log saved to: {log_file}")
            except Exception as e:
                print(f"Failed to save crash log: {e}")
            
            sys.__excepthook__(exc_type, exc_value, exc_traceback)
        
        sys.excepthook = handle_exception
        
        try:
            import kivy
            from kivy.base import ExceptionHandler, ExceptionManager
            
            class KivyCrashHandler(ExceptionHandler):
                def handle_exception(self, inst):
                    handle_exception(type(inst), inst, inst.__traceback__)
                    return ExceptionManager.PASS
            
            ExceptionManager.add_handler(KivyCrashHandler())
        except ImportError:
            pass
        ENDOFFILE
        
        if [ -f main.py ]; then
          cat crash_handler.py main.py > main_temp.py && mv main_temp.py main.py
          echo "Crash handler injected into main.py"
        fi

    - name: Build APK with Buildozer
      run: |
        mkdir -p bin
        
        if [ -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        fi
        
        buildozer -v android debug
      env:
        BUILDOZER_ALLOW_ORG_NAME_START_WITH_NUMBER: 1
      timeout-minutes: 60

    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: bin/*.apk
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          buildozer.log
          .buildozer/android/platform/build-*/build.log
        retention-days: 7
        if-no-files-found: warn

    - name: Create crash log README
      if: success()
      run: |
        cat > CRASH_LOG_README.txt << 'ENDOFFILE'
        DaveSaveEd 崩溃日志收集说明
        =============================
        
        如果应用闪退，请按以下步骤获取日志：
        
        方法一：通过 USB 调试（需要电脑）
        1. 手机开启开发者选项和 USB 调试
        2. 连接电脑，运行命令：adb logcat -d > crash_log.txt
        3. 在 logcat 中搜索 "Python" 或 "DaveSaveEd" 相关错误
        
        方法二：检查本地日志文件
        1. 打开手机文件管理器
        2. 进入 /sdcard/DaveSaveEd/crashes/ 目录
        3. 查找 crash_*.log 文件
        
        常见闪退原因：
        - 缺少存储权限：请手动授予"所有文件访问权限"
        - Android 11+ 需要特殊权限处理
        ENDOFFILE
        cp CRASH_LOG_README.txt bin/

    - name: Upload crash log helper
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: crash-log-instructions
        path: CRASH_LOG_README.txt
        retention-days: 30