name: Build Kivy Android APK In Release Mode

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

jobs:
  build-android:
    # 关键修改：强制使用 Ubuntu 22.04，这是构建 APK 最稳定的环境
    # 避开 Ubuntu 24.04 的 Clang 兼容性问题
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        # Ubuntu 22.04 完美支持 libtinfo5 和旧版库，不会报错
        sudo apt-get install -y \
            build-essential \
            git zip unzip \
            autoconf automake libtool pkg-config \
            libffi-dev libssl-dev \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake gettext libltdl-dev

    - name: Install Buildozer and Cython
      run: |
        # 锁定 Cython 版本
        pip3 install --user --upgrade "buildozer>=1.5.0" "Cython==0.29.33"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Clean Buildozer Cache
      run: |
        # 强制清理缓存，防止上次失败的编译文件残留
        rm -rf .buildozer
        rm -rf bin

    - name: Build with Buildozer
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        buildozer android release
      env:
        BUILDOZER_ALLOW_ORG_NAME_START_WITH_NUMBER: 1

    - name: Prepare artifacts
      run: |
        mkdir -p output
        find bin/ -name "*.apk" -exec cp {} ./output/ \; 2>/dev/null || true

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: DaveSaveEd-Release-APK
        path: ./output/*.apk
