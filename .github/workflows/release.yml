name: Build Kivy Android APK In Release Mode

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64
  CYTHON_LANGUAGE_LEVEL: "3"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.java-home=$JAVA_HOME -Dorg.gradle.jvmargs=-Xmx2048m"

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            git zip unzip \
            python3-pip autoconf automake libtool \
            pkg-config zlib1g-dev libncurses5-dev \
            libncursesw5-dev cmake libffi-dev \
            libssl-dev gettext libltdl-dev

    - name: Install buildozer and cython
      run: |
        # 固定 Cython 版本以避免编译错误
        pip3 install --user --upgrade "buildozer>=1.5.0" "Cython==0.29.33"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Build with Buildozer
      run: |
        # 预先接受 SDK 协议
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        # 开始构建
        buildozer android release

    - name: Prepare artifacts
      run: |
        # 查找生成的 APK 并移至根目录方便上传
        find . -name "*.apk" -exec cp {} ./ \; 2>/dev/null || true

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kivy-release-apk
        path: ./*.apk
        retention-days: 30
